<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedure Editor V40.0</title>
    <link rel="icon" type="image/png" href="https://github.com/asendia2025/mfg-capa/blob/main/img/logo_company.png?raw=true">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Inter"', '"Noto Sans KR"', 'sans-serif'] },
                    colors: { zinc: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; overflow: hidden; background-color: #3f3f46; } 
        .editor-content { font-family: 'Noto Sans KR', sans-serif; min-height: 100%; position: relative; outline: none; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #27272a; }
        ::-webkit-scrollbar-thumb { background-color: #71717a; border-radius: 4px; }
        .editor-content:empty:before { content: 'Select DOC TYPE or Load File...'; color: #a1a1aa; pointer-events: none; font-style: italic; }
        #img-resizer-handle { position: fixed; width: 14px; height: 14px; background: #3b82f6; border: 2px solid white; z-index: 1000; cursor: se-resize; border-radius: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); display: none; }
        .editor-content img { max-width: 100%; border-radius: 4px; display: block; cursor: pointer; transition: outline 0.1s; margin: 10px 0; }
        .editor-content img.selected { outline: 4px solid #3b82f6; outline-offset: 1px; }
        .editor-content table { border-collapse: collapse; width: calc(100% - 3rem); margin: 10px 0 10px 3rem; table-layout: fixed; }
        .editor-content th, .editor-content td { border: 1px solid #d4d4d8; padding: 8px; text-align: left; position: relative; min-width: 40px; }
        .editor-content th { background-color: #f4f4f5; font-weight: bold; }
        .resizer { position: absolute; top: 0; right: -2px; width: 5px; height: 100%; cursor: col-resize; user-select: none; z-index: 10; }
        .button { cursor: pointer; position: relative; display: inline-flex; align-items: center; justify-content: center; border-radius: 9999px; border: none; padding: 6px 16px; min-height: 32px; color: white; font-weight: 500; font-size: 13px; background: #4f46e5; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="img-resizer-handle"></div>

    <div class="w-full max-w-[1400px] h-[92vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden relative border border-zinc-600">
        
        <div class="h-12 bg-zinc-50 border-b border-zinc-200 flex items-center justify-between px-6 shrink-0 z-30">
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-400"></div><div class="w-3 h-3 rounded-full bg-amber-400"></div><div class="w-3 h-3 rounded-full bg-green-400"></div></div>
            <div class="flex-1 max-w-xl mx-4 text-center text-[10px] font-bold text-zinc-400 tracking-widest uppercase">mfg.tech.center / AI High-Performance Editor V40.0</div>
            
            <div class="flex items-center gap-2">
                <button onclick="openAiModal('refine')" class="flex items-center gap-2 px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-600 rounded text-[10px] font-bold transition">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> AI Refine (KO)
                </button>
                <button onclick="openAiModal('translate')" class="flex items-center gap-2 px-3 py-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded text-[10px] font-bold transition">
                    <i data-lucide="languages" class="w-3 h-3"></i> AI Translate (EN)
                </button>
            </div>
            <div id="trans-loader" class="loader hidden ml-2"></div>
        </div>

        <div class="bg-white border-b border-zinc-200 p-4 shrink-0 font-sans z-20 shadow-sm">
            <div class="flex flex-wrap gap-4 items-start">
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Type</label>
                    <select id="meta-type" onchange="updateMeta()" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-28 outline-none">
                        <option value="" disabled selected>select</option><option value="RFG">RFG</option><option value="RFM">RFM</option><option value="EVC">EVC</option>
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Model</label>
                    <input type="text" id="meta-model" oninput="updateMeta()" placeholder="Model" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-24 outline-none">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Process</label>
                    <select id="meta-process" onchange="updateMeta()" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-28 outline-none">
                        <option value="" disabled selected>select</option><option value="ASSEMBLY">ASSEMBLY</option><option value="TEST">TEST</option>
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Step</label>
                    <input type="text" id="meta-step" onblur="formatStep(this); updateMeta()" oninput="checkStepAuto(this); updateMeta()" placeholder="001" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-20 text-center outline-none">
                </div>
                <div class="flex flex-col gap-1 flex-1">
                    <div class="flex gap-2 w-full">
                        <div class="flex-1">
                            <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Process Name</label>
                            <input type="text" id="meta-name" oninput="updateMeta(); saveHistory();" placeholder="Process Name" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-900 text-xs w-full outline-none">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest">Doc Type</label>
                            <select id="meta-doc-type" onchange="changeDocType(this.value)" class="bg-indigo-50 border border-indigo-100 rounded px-2 py-1.5 font-bold text-indigo-700 text-xs outline-none cursor-pointer">
                                <option value="" disabled selected>select</option><option value="CONTENTS">Contents</option><option value="HISTORY">History</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="pb-4 ml-auto self-center flex gap-2">
                    <button type="button" class="button bg-zinc-500" onclick="document.getElementById('file-load-input').click()" title="Load HTML file">Load HTML</button>
                    <input type="file" id="file-load-input" accept=".html" class="hidden" onchange="handleFileLoad(this)">
                    <button type="button" class="button" onclick="saveHtml()" title="Save as HTML">Save HTML</button>
                </div>
            </div>
            <div class="mt-2 text-[10px] text-zinc-400 font-bold uppercase tracking-wide">Filename: <span id="full-name-display" class="text-indigo-500">-.html</span></div>
        </div>

        <div class="w-full flex-1 flex flex-col h-full bg-zinc-100 overflow-hidden relative">
            <div class="bg-white border-b border-zinc-200 p-2 flex flex-wrap gap-2 items-center shrink-0 z-10 shadow-sm">
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onclick="undo()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Undo (Ctrl+Z)"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
                    <button onclick="redo()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Redo (Ctrl+Y)"><i data-lucide="redo-2" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); execCmd('justifyLeft')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Align Left"><i data-lucide="align-left" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('justifyCenter')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Align Center"><i data-lucide="align-center" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('justifyRight')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Align Right"><i data-lucide="align-right" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 bg-zinc-100 p-1 rounded-lg border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); applyStyle('H1')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-800 text-xs font-bold" title="H1 (0 Tab)">H1</button>
                    <button onmousedown="event.preventDefault(); applyStyle('H2')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-700 text-xs font-bold" title="H2 (1 Tab)">H2</button>
                    <button onmousedown="event.preventDefault(); applyStyle('P')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-600 text-xs font-medium" title="Text (2 Tab)">T</button>
                    <button onmousedown="event.preventDefault(); applyStyle('TB')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-900 text-xs font-bold underline decoration-indigo-500" title="Bold (2 Tab)">B</button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#000000')" class="w-5 h-5 rounded bg-black border" title="Black Text"></button>
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#ef4444')" class="w-5 h-5 rounded bg-red-500 border" title="Red Text"></button>
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#3b82f6')" class="w-5 h-5 rounded bg-blue-500 border" title="Blue Text"></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); execCmd('hiliteColor', '#fef08a')" class="w-5 h-5 rounded bg-yellow-200 flex justify-center items-center" title="Yellow Highlight"><i data-lucide="highlighter" class="w-3 h-3 text-yellow-600"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('hiliteColor', '#fbcfe8')" class="w-5 h-5 rounded bg-pink-200 flex justify-center items-center" title="Pink Highlight"><i data-lucide="highlighter" class="w-3 h-3 text-pink-600"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('hiliteColor', '#bbf7d0')" class="w-5 h-5 rounded bg-green-200 flex justify-center items-center" title="Green Highlight"><i data-lucide="highlighter" class="w-3 h-3 text-green-600"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); insertStatusIcon('warning')" class="p-1.5 hover:bg-red-50 rounded text-red-600" title="Warning"><i data-lucide="alert-triangle" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); insertStatusIcon('caution')" class="p-1.5 hover:bg-amber-50 rounded text-amber-600" title="Caution"><i data-lucide="alert-circle" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); insertStatusIcon('crucial')" class="p-1.5 hover:bg-blue-50 rounded text-blue-600" title="Point"><i data-lucide="target" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); insertTable()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Insert Table"><i data-lucide="table" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('merge', 'right')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Merge Right"><i data-lucide="arrow-right-from-line" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('merge', 'down')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Merge Down"><i data-lucide="arrow-down-from-line" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('split')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Split"><i data-lucide="grid-2x2" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); modifyTable('row', 'add')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Add Row"><i data-lucide="list-plus" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('row', 'del')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Del Row"><i data-lucide="list-x" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('col', 'add')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Add Col"><i data-lucide="columns" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('col', 'del')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Del Col"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                </div>
                <label class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600 cursor-pointer" title="Load Image">
                    <i data-lucide="image-plus" class="w-4 h-4"></i>
                    <input type="file" id="image-upload-input" accept="image/*" class="hidden" onchange="insertImageFromFile(this)">
                </label>
            </div>

            <div class="w-full flex-1 overflow-y-auto p-8 bg-zinc-800/10 scroll-smooth" id="canvas-wrapper">
                <div class="max-w-[210mm] mx-auto bg-white shadow-lg border border-zinc-200 min-h-full flex flex-col relative">
                    <div id="editor" contenteditable="true" class="editor-content flex-1 p-12 focus:outline-none text-zinc-800 leading-relaxed text-base" oninput="saveHistory()"></div>
                </div>
            </div>
    </div>

    <div id="api-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-96">
            <h3 id="api-title" class="text-lg font-bold mb-4 text-zinc-900 tracking-tight">AI Assistant</h3>
            <p id="api-desc" class="text-xs text-zinc-500 mb-4 font-sans"></p>
            <input type="password" id="api-key-input" class="w-full border rounded px-3 py-2 text-sm mb-4 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Paste API Key here">
            <input type="hidden" id="ai-mode">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('api-modal').classList.add('hidden')" class="px-4 py-2 text-xs font-bold text-zinc-500">Cancel</button>
                <button onclick="runAiProcess()" class="px-4 py-2 text-xs font-bold bg-indigo-600 text-white rounded">Execute</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const editor = document.getElementById('editor');
        const handle = document.getElementById('img-resizer-handle');
        const historyStack = []; let historyIndex = -1;
        let lastRange = null; let currentImg = null;
        const DEFAULT_GEMINI_KEY = "AIzaSyDde61z3tmJxEF5z8K7PdtA5VPIDfvSfdk";

        function saveHistory() {
            const content = editor.innerHTML;
            if (historyIndex >= 0 && historyStack[historyIndex] === content) return;
            if (historyIndex < historyStack.length - 1) historyStack.splice(historyIndex + 1);
            historyStack.push(content); if (historyStack.length > 50) historyStack.shift(); else historyIndex++;
        }
        function undo() { if (historyIndex > 0) { historyIndex--; editor.innerHTML = historyStack[historyIndex]; initInteractive(); } }
        function redo() { if (historyIndex < historyStack.length - 1) { historyIndex++; editor.innerHTML = historyStack[historyIndex]; initInteractive(); } }

        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                if (editor.contains(range.commonAncestorContainer)) lastRange = range.cloneRange();
            }
        }
        editor.addEventListener('mouseup', saveSelection);
        editor.addEventListener('keyup', saveSelection);

        // --- IMPROVED AI PROCESSOR (Detailed Error Handling) ---
        function openAiModal(mode) {
            const modal = document.getElementById('api-modal');
            document.getElementById('ai-mode').value = mode;
            document.getElementById('api-title').innerText = mode === 'translate' ? "AI Engineering Translate (EN → KO)" : "AI Engineering Refine (KO → KO)";
            document.getElementById('api-desc').innerText = mode === 'translate' ? "Professional technical translation using engineering terminology." : "Refines field slang into formal technical standards.";
            document.getElementById('api-key-input').value = DEFAULT_GEMINI_KEY;
            modal.classList.remove('hidden');
        }

        async function runAiProcess() {
            const key = document.getElementById('api-key-input').value.trim();
            const mode = document.getElementById('ai-mode').value;
            if(!key) return alert("API Key is missing.");

            const loader = document.getElementById('trans-loader');
            loader.classList.remove('hidden');
            document.getElementById('api-modal').classList.add('hidden');

            let prompt = "";
            if (mode === 'translate') {
                prompt = `Technical Documentation Expert. Translate this English HTML to Korean. USE formal engineering terms (e.g., 'Assemble' -> '조립', 'Torque' -> '체결 토크'). Keep HTML tags. Output ONLY the raw HTML string. HTML: ${editor.innerHTML}`;
            } else {
                prompt = `Manufacturing Expert. Refine this Korean HTML. Change slang like '빠가' to '나사산 파손/마모', '야마' to '나사산 변형'. Ensure formal engineering language for procedures. Keep HTML tags. Output ONLY the raw HTML string. HTML: ${editor.innerHTML}`;
            }

            try {
                // MODEL: gemini-2.5-flash
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : "Network response was not OK");
                }

                const data = await response.json();
                if(data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0].text) {
                    let aiResult = data.candidates[0].content.parts[0].text.replace(/```html|```/g, '').trim();
                    editor.innerHTML = aiResult;
                    saveHistory();
                    initInteractive();
                } else {
                    throw new Error("AI returned an empty response. Check if model name 'gemini-2.5-flash' is valid for your region.");
                }
            } catch(e) {
                console.error("AI Error:", e);
                alert("AI Error: " + e.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function insertStatusIcon(type) {
            let svg = "";
            if (type === 'warning') svg = `<span style="color:#ef4444; font-weight:bold; display:inline-flex; align-items:center; gap:4px; vertical-align:middle;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> 경고: </span>&nbsp;`;
            else if (type === 'caution') svg = `<span style="color:#f59e0b; font-weight:bold; display:inline-flex; align-items:center; gap:4px; vertical-align:middle;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg> 주의: </span>&nbsp;`;
            else if (type === 'crucial') svg = `<span style="color:#3b82f6; font-weight:bold; display:inline-flex; align-items:center; gap:4px; vertical-align:middle;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg> 급소: </span>&nbsp;`;
            editor.focus();
            const sel = window.getSelection();
            if (lastRange) { sel.removeAllRanges(); sel.addRange(lastRange); }
            document.execCommand('insertHTML', false, svg);
            saveHistory();
        }

        function insertImageFromFile(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = "100%"; 
                editor.focus();
                const sel = window.getSelection();
                if (lastRange) { sel.removeAllRanges(); sel.addRange(lastRange); }
                if (sel.rangeCount > 0) {
                    const range = sel.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(img);
                    const br = document.createElement('p'); br.innerHTML = '<br>';
                    img.after(br);
                } else { editor.appendChild(img); }
                saveHistory(); deselectImage();
            };
            reader.readAsDataURL(input.files[0]);
            input.value = '';
        }

        editor.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG') { e.stopPropagation(); selectImage(e.target); } else { deselectImage(); }
        });

        function selectImage(img) {
            deselectImage();
            currentImg = img;
            img.classList.add('selected');
            handle.style.display = 'block';
            updateHandlePosition();
            handle.onmousedown = (e) => {
                e.preventDefault();
                const startX = e.clientX, startW = img.offsetWidth, ratio = img.offsetHeight / img.offsetWidth;
                document.onmousemove = (me) => {
                    img.style.width = (startW + (me.clientX - startX)) + 'px';
                    img.style.height = (img.offsetWidth * ratio) + 'px';
                    updateHandlePosition();
                };
                document.onmouseup = () => { document.onmousemove = null; saveHistory(); };
            };
        }

        function updateHandlePosition() {
            if (!currentImg) return;
            const rect = currentImg.getBoundingClientRect();
            handle.style.top = (rect.top + rect.height - 7) + 'px';
            handle.style.left = (rect.left + rect.width - 7) + 'px';
        }

        function deselectImage() {
            handle.style.display = 'none';
            editor.querySelectorAll('img').forEach(img => img.classList.remove('selected'));
            currentImg = null;
        }

        document.getElementById('canvas-wrapper').addEventListener('scroll', updateHandlePosition);
        document.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace') && currentImg) {
                e.preventDefault(); currentImg.remove(); deselectImage(); saveHistory();
            }
        });

        function modifyTable(target, action) {
            const sel = window.getSelection(); if (!sel.rangeCount) return;
            let cell = sel.anchorNode; while(cell && cell.nodeName !== 'TD' && cell.nodeName !== 'TH') { cell = cell.parentNode; if(cell === editor) return; }
            if(!cell) return alert("Inside table cell first.");
            const row = cell.parentNode, table = row.parentNode.parentNode;
            if (target === 'merge') {
                if (action === 'right' && cell.nextElementSibling) { cell.colSpan = (cell.colSpan || 1) + (cell.nextElementSibling.colSpan || 1); cell.nextElementSibling.remove(); }
                else if (action === 'down' && table.rows[row.rowIndex + 1]) { const below = table.rows[row.rowIndex + 1].cells[cell.cellIndex]; if(below) { cell.rowSpan = (cell.rowSpan || 1) + (below.rowSpan || 1); below.remove(); } }
            } else if (target === 'split') { cell.colSpan = 1; cell.rowSpan = 1; }
            else if (target === 'row') {
                if (action === 'add') { const nr = table.insertRow(row.rowIndex + 1); for(let i=0; i<row.cells.length; i++) { const c = nr.insertCell(i); c.style.border="1px solid #d4d4d8"; c.style.padding="8px"; c.innerHTML="&nbsp;"; } }
                else if (action === 'del' && table.rows.length>1) table.deleteRow(row.rowIndex);
            } else if (target === 'col') {
                const idx = cell.cellIndex;
                if (action === 'add') { for(let i=0; i<table.rows.length; i++) { const c = table.rows[i].insertCell(idx+1); c.style.border="1px solid #d4d4d8"; c.style.padding="8px"; c.innerHTML="&nbsp;"; if(table.rows[i].cells[idx].tagName==='TH') c.outerHTML='<th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5;">H</th>'; } }
                else if (action === 'del') { for(let i=0; i<table.rows.length; i++) { if(table.rows[i].cells.length>1) table.rows[i].deleteCell(idx); } }
            }
            saveHistory(); attachResizers();
        }

        function attachResizers() {
            editor.querySelectorAll('table').forEach(table => {
                if (!table.rows[0]) return;
                Array.from(table.rows[0].cells).forEach(cell => {
                    if (cell.querySelector('.resizer')) return;
                    const r = document.createElement('div'); r.className = 'resizer'; r.contentEditable = false; cell.appendChild(r);
                    r.onmousedown = (e) => { 
                        let x = e.clientX, w = parseInt(getComputedStyle(cell).width, 10);
                        document.onmousemove = (me) => cell.style.width = (w + me.clientX - x) + 'px';
                        document.onmouseup = () => { document.onmousemove = null; saveHistory(); };
                        e.preventDefault();
                    };
                });
            });
        }

        function initInteractive() { attachResizers(); deselectImage(); }
        window.onload = function() {
            updateMeta(); document.execCommand('defaultParagraphSeparator', false, 'p'); saveHistory();
            new MutationObserver(() => initInteractive()).observe(editor, { childList: true, subtree: true });
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
            });
        };

        function execCmd(c, v=null) {
            if (currentImg && ['justifyLeft', 'justifyCenter', 'justifyRight'].includes(c)) {
                currentImg.style.marginLeft = (c === 'justifyLeft') ? "0" : "auto";
                currentImg.style.marginRight = (c === 'justifyRight') ? "0" : "auto";
                updateHandlePosition();
            } else { document.execCommand(c, false, v); }
            editor.focus(); saveHistory();
        }

        function applyStyle(t) {
            document.execCommand('formatBlock', false, 'p'); const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                let n = sel.anchorNode; while (n && n.nodeName !== 'P' && n !== editor) n = n.parentNode;
                if (n && n.nodeName === 'P') {
                    n.className = t==='H1' ? 'text-xl font-bold text-black mb-4 mt-6 pl-0' : t==='H2' ? 'text-lg font-bold text-black mb-3 mt-4 pl-6' : 'text-base text-black mb-2 pl-12';
                    if(t==='TB') n.classList.add('font-bold');
                }
            }
            saveHistory();
        }

        function changeDocType(type) {
            const name = document.getElementById('meta-name').value || "Process Name";
            if (type === 'CONTENTS') editor.innerHTML = `<h1 class="text-xl font-bold text-black mb-4 mt-6 pl-0">1. ${name}</h1><p class="text-base text-black mb-2 pl-12">Start typing here...</p>`;
            else if (type === 'HISTORY') editor.innerHTML = `<h1 class="text-xl font-bold text-black mb-4 mt-6 pl-0">Revision History</h1><table style="width:calc(100% - 3rem); border-collapse: collapse; margin-left:3rem;"><thead><tr><th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:80px;">Rev.</th><th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:120px;">Date</th><th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5;">Description</th><th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:120px;">Author</th></tr></thead><tbody><tr><td style="border:1px solid #d4d4d8; padding:8px;">001</td><td style="border:1px solid #d4d4d8; padding:8px;">${new Date().toISOString().split('T')[0]}</td><td style="border:1px solid #d4d4d8; padding:8px;">Initial Release</td><td style="border:1px solid #d4d4d8; padding:8px;">&nbsp;</td></tr></tbody></table><br>`;
            saveHistory(); initInteractive();
        }

        function handleFileLoad(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const doc = new DOMParser().parseFromString(e.target.result, "text/html");
                try {
                    const meta = doc.querySelector('.meta').innerText.split(' / ');
                    document.getElementById('meta-type').value = meta[0].trim();
                    document.getElementById('meta-model').value = meta[1].trim();
                    document.getElementById('meta-process').value = meta[2].trim();
                    document.getElementById('meta-step').value = doc.querySelector('.badge-black').innerText.trim();
                    document.getElementById('meta-name').value = doc.querySelector('h1').innerText.trim();
                } catch(err) {}
                editor.innerHTML = doc.querySelector('main').innerHTML;
                saveHistory(); updateMeta(); initInteractive();
            };
            reader.readAsText(input.files[0]);
            input.value = '';
        }

        function saveHtml() {
            deselectImage(); const meta = updateMeta();
            const temp = document.createElement('div'); temp.innerHTML = editor.innerHTML;
            temp.querySelectorAll('.resizer, .img-handle').forEach(el => el.remove());
            const content = temp.innerHTML.replace(/text-zinc-[0-9]+/g, 'text-black');
            const finalHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${meta.full}</title><script src="https://cdn.tailwindcss.com"><\/script><script src="https://unpkg.com/lucide@latest"><\/script><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"><style>body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f4f4f5; margin: 0; padding: 40px 0; display: flex; justify-content: center; } .paper { width: 210mm; min-height: 297mm; background: white; padding: 40px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); position: relative; display: flex; flex-direction: column; } header { border-bottom: 4px double #000; padding-bottom: 20px; margin-bottom: 30px; } .badge-black { background: #000; color: #fff; padding: 2px 10px; border-radius: 9999px; font-size: 12px; font-weight: 700; } .meta { display: flex; align-items: center; gap: 24px; text-[10px] font-bold text-zinc-500 uppercase tracking-widest; padding-left: 3rem; margin-bottom: 12px; } main { flex: 1; line-height: 1.6; color: #000; padding-left: 3rem; } footer { border-top: 1px solid #e2e8f0; margin-top: 50px; padding-top: 20px; text-align: center; opacity: 0.5; } img { border-radius: 4px; }</style></head><body><div class="paper"><header><div class="meta">${meta.type} / ${meta.model} / ${meta.proc}</div><div class="flex items-end gap-4" style="padding-left:3rem;"><span class="badge-black">${meta.step}</span><h1 style="font-size:28px; font-weight:800; margin:0;">${meta.name}</h1></div></header><main>${content}</main><footer><img src="https://asendia2025.github.io/mfg-capa/img/logo_company.png" style="height:18px; margin:0 auto 6px;"><div style="font-size:9px; font-weight:700; color:#94a3b8; text-transform:uppercase;">Manufacturing Technology Center</div></footer></div><script>lucide.createIcons();<\/script></body></html>`;
            saveAs(new Blob([finalHtml], {type: "text/html;charset=utf-8"}), `${meta.full}.html`);
        }

        function formatStep(i) { i.value = i.value.replace(/[^0-9]/g, '').padStart(3, '0') || '001'; }
        function updateMeta() {
            const s = document.getElementById('meta-step').value || "001", n = document.getElementById('meta-name').value || "NAME";
            const full = `${s}-${n.replace(/[^a-zA-Z0-9\s-_]/g, '').trim()}`;
            document.getElementById('full-name-display').innerText = full + ".html";
            return { full, step: s, name: n, type: document.getElementById('meta-type').value, model: document.getElementById('meta-model').value, proc: document.getElementById('meta-process').value };
        }
        function checkStepAuto(i) { if(i.value === '000') document.getElementById('meta-name').value = "DOC. Revision History"; updateMeta(); }
    </script>
</body>
</html>