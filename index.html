<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedure Editor V48.0</title>
    <link rel="icon" type="image/png" href="https://github.com/asendia2025/mfg-capa/blob/main/img/logo_company.png?raw=true">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Inter"', '"Noto Sans KR"', 'sans-serif'] },
                    colors: { zinc: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b' } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; overflow: hidden; background-color: #3f3f46; } 
        .editor-content { font-family: 'Inter', 'Noto Sans KR', sans-serif; min-height: 100%; position: relative; outline: none; }
        .editor-content b, .editor-content strong { font-weight: 700; color: inherit; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #27272a; }
        ::-webkit-scrollbar-thumb { background-color: #71717a; border-radius: 4px; }
        .editor-content:empty:before { content: 'Select DOC TYPE or Load File...'; color: #a1a1aa; pointer-events: none; font-style: italic; }
        #img-resizer-handle { position: fixed; width: 14px; height: 14px; background: #3b82f6; border: 2px solid white; z-index: 1000; cursor: se-resize; border-radius: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); display: none; }
        .editor-content img { max-width: 100%; border-radius: 4px; display: block; cursor: pointer; transition: outline 0.1s; margin: 10px 0; }
        .editor-content img.selected { outline: 4px solid #3b82f6; outline-offset: 1px; }
        .editor-content table { border-collapse: collapse; width: calc(100% - 3rem); margin: 10px 0 10px 3rem; table-layout: fixed; }
        .editor-content th, .editor-content td { border: 1px solid #d4d4d8; padding: 8px; text-align: left; position: relative; min-width: 40px; }
        .editor-content th { background-color: #f4f4f5; font-weight: bold; }
        .resizer { position: absolute; top: 0; right: -2px; width: 5px; height: 100%; cursor: col-resize; user-select: none; z-index: 10; }
        .button { cursor: pointer; position: relative; display: inline-flex; align-items: center; justify-content: center; border-radius: 9999px; border: none; padding: 6px 16px; min-height: 32px; color: white; font-weight: 500; font-size: 13px; background: #4f46e5; transition: filter 0.2s; }
        .button:hover { filter: brightness(1.1); }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .paper-a4 { width: 210mm; }
        .paper-wide { width: 350mm; }
        .uppercase-input { text-transform: uppercase; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div id="img-resizer-handle"></div>

    <div class="w-full max-w-[1400px] h-[92vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden relative border border-zinc-600">
        
        <div class="h-12 bg-zinc-50 border-b border-zinc-200 flex items-center justify-between px-6 shrink-0 z-30">
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-400"></div><div class="w-3 h-3 rounded-full bg-amber-400"></div><div class="w-3 h-3 rounded-full bg-green-400"></div></div>
            <div class="flex-1 max-w-xl mx-4 text-center text-[10px] font-bold text-zinc-400 tracking-widest uppercase">mfg.tech.center / Procedure Editor V48.0</div>
            
            <div class="flex items-center gap-2">
                <button onclick="openAiModal('refine')" class="flex items-center gap-2 px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-600 rounded text-[10px] font-bold transition">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> AI Refine (KO)
                </button>
                <button onclick="openAiModal('translate')" class="flex items-center gap-2 px-3 py-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded text-[10px] font-bold transition">
                    <i data-lucide="languages" class="w-3 h-3"></i> AI Translate (EN)
                </button>
            </div>
            <div id="trans-loader" class="loader hidden ml-2"></div>
        </div>

        <div class="bg-white border-b border-zinc-200 p-4 shrink-0 font-sans z-20 shadow-sm">
            <div class="flex flex-wrap gap-4 items-start">
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Type</label>
                    <select id="meta-type" onchange="updateMeta()" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-28 outline-none"><option value="" disabled selected>select</option><option value="RFG">RFG</option><option value="RFM">RFM</option><option value="EVC">EVC</option></select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Model</label>
                    <input type="text" id="meta-model" oninput="this.value = this.value.toUpperCase(); updateMeta()" placeholder="Model" class="uppercase-input bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-24 outline-none">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Process</label>
                    <select id="meta-process" onchange="updateMeta()" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-28 outline-none"><option value="" disabled selected>select</option><option value="ASSEMBLY">ASSEMBLY</option><option value="TEST">TEST</option></select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Step</label>
                    <input type="text" id="meta-step" onblur="formatStep(this); updateMeta()" oninput="checkStepAuto(this); updateMeta()" placeholder="001" class="uppercase-input bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-20 text-center outline-none">
                </div>
                <div class="flex flex-col gap-1 flex-1">
                    <div class="flex gap-2 w-full">
                        <div class="flex-1">
                            <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Process Name</label>
                            <input type="text" id="meta-name" oninput="this.value = this.value.toUpperCase(); updateMeta(); saveHistory();" placeholder="Process Name" class="uppercase-input bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-900 text-xs w-full outline-none">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest">Doc Type</label>
                            <select id="meta-doc-type" onchange="changeDocType(this.value)" class="bg-indigo-50 border border-indigo-100 rounded px-2 py-1.5 font-bold text-indigo-700 text-xs outline-none cursor-pointer">
                                <option value="" disabled selected>select</option><option value="CONTENTS">Contents</option><option value="HISTORY">History</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold text-zinc-400 uppercase tracking-widest">Layout</label>
                    <select id="page-layout" onchange="changePageWidth(this.value)" class="bg-zinc-100 border-none rounded px-2 py-1.5 font-bold text-zinc-700 text-xs w-28 outline-none cursor-pointer">
                        <option value="paper-a4" selected>A4 Portrait</option>
                        <option value="paper-wide">A4 Wide</option>
                    </select>
                </div>
                <div class="pb-4 ml-auto self-center flex gap-2">
                    <button type="button" class="button bg-zinc-500" onclick="document.getElementById('file-load-input').click()" title="Load HTML file">Load HTML</button>
                    <input type="file" id="file-load-input" accept=".html" class="hidden" onchange="handleFileLoad(this)">
                    <button type="button" class="button" onclick="saveHtml()" title="Save as HTML">Save HTML</button>
                </div>
            </div>
            <div class="mt-2 text-[10px] text-zinc-400 font-bold uppercase tracking-wide">Filename: <span id="full-name-display" class="text-indigo-500">-.html</span></div>
        </div>

        <div class="w-full flex-1 flex flex-col h-full bg-zinc-100 overflow-hidden relative">
            <div class="bg-white border-b border-zinc-200 p-2 flex flex-wrap gap-2 items-center shrink-0 z-10 shadow-sm">
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onclick="undo()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Undo"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
                    <button onclick="redo()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Redo"><i data-lucide="redo-2" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); execCmd('justifyLeft')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600"><i data-lucide="align-left" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('justifyCenter')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600"><i data-lucide="align-center" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('justifyRight')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600"><i data-lucide="align-right" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 bg-zinc-100 p-1 rounded-lg border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); applyStyle('H1')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-800 text-xs font-bold" title="H1 (0 Tab)">H1</button>
                    <button onmousedown="event.preventDefault(); applyStyle('H2')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-700 text-xs font-bold" title="H2 (1 Tab)">H2</button>
                    <button onmousedown="event.preventDefault(); applyStyle('P')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-600 text-xs font-medium" title="Text (2 Tab)">T</button>
                    <button onmousedown="event.preventDefault(); execCmd('bold')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-900 text-xs font-bold underline decoration-indigo-500" title="Bold Selection">B</button>
                    <button onmousedown="event.preventDefault(); execCmd('removeFormat')" class="px-3 py-1.5 hover:bg-white rounded text-zinc-500 text-xs font-medium" title="Clear Formatting">Tx</button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#000000')" class="w-5 h-5 rounded bg-black border" title="Black"></button>
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#ef4444')" class="w-5 h-5 rounded bg-red-500 border" title="Red"></button>
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#3b82f6')" class="w-5 h-5 rounded bg-blue-500 border" title="Blue"></button>
                    <button onmousedown="event.preventDefault(); execCmd('foreColor', '#4b5563')" class="w-5 h-5 rounded bg-gray-600 border" title="Gray"></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); execCmd('hiliteColor', '#fef08a')" class="w-5 h-5 rounded bg-yellow-200 flex justify-center items-center" title="Highlight Yellow"><i data-lucide="highlighter" class="w-3 h-3 text-yellow-600"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('hiliteColor', '#fbcfe8')" class="w-5 h-5 rounded bg-pink-200 flex justify-center items-center" title="Highlight Pink"><i data-lucide="highlighter" class="w-3 h-3 text-pink-600"></i></button>
                    <button onmousedown="event.preventDefault(); execCmd('hiliteColor', '#bbf7d0')" class="w-5 h-5 rounded bg-green-200 flex justify-center items-center" title="Highlight Green"><i data-lucide="highlighter" class="w-3 h-3 text-green-600"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); insertStatusIcon('warning')" class="p-1.5 hover:bg-red-50 rounded text-red-600" title="Warning"><i data-lucide="alert-triangle" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); insertStatusIcon('caution')" class="p-1.5 hover:bg-amber-50 rounded text-amber-600" title="Caution"><i data-lucide="alert-circle" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); insertStatusIcon('crucial')" class="p-1.5 hover:bg-blue-50 rounded text-blue-600" title="Point"><i data-lucide="target" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); openTableModal()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Insert Table (Custom)"><i data-lucide="table" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('row', 'add')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Add Row"><i data-lucide="list-plus" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('row', 'del')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Del Row"><i data-lucide="list-x" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('col', 'add')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Add Col"><i data-lucide="columns" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('col', 'del')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Del Col"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('merge', 'right')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Merge Right"><i data-lucide="arrow-right-from-line" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('merge', 'down')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Merge Down"><i data-lucide="arrow-down-from-line" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); modifyTable('split')" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Split"><i data-lucide="grid-2x2" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 border-r border-zinc-200 pr-2">
                    <button onmousedown="event.preventDefault(); insertPageBreak()" class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600" title="Insert Page Break"><i data-lucide="scissors" class="w-4 h-4"></i></button>
                    <button onmousedown="event.preventDefault(); deletePageBreak()" class="p-1.5 hover:bg-red-50 rounded text-red-600" title="Delete Last Page Break"><i data-lucide="scissors-line-dashed" class="w-4 h-4"></i></button>
                </div>
                <label class="p-1.5 hover:bg-zinc-100 rounded text-zinc-600 cursor-pointer" title="Load Image">
                    <i data-lucide="image-plus" class="w-4 h-4"></i>
                    <input type="file" id="image-upload-input" accept="image/*" class="hidden" onchange="insertImageFromFile(this)">
                </label>
            </div>

            <div class="w-full flex-1 overflow-y-auto p-8 bg-zinc-800/10 scroll-smooth" id="canvas-wrapper">
                <div id="paper-container" class="paper-a4 mx-auto bg-white shadow-lg border border-zinc-200 min-h-full flex flex-col relative transition-all duration-300">
                    <div id="editor" contenteditable="true" class="editor-content flex-1 p-12 focus:outline-none text-zinc-800 leading-relaxed text-base" oninput="saveHistory()"></div>
                </div>
            </div>
    </div>

    <div id="api-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-96 font-sans">
            <h3 id="api-title" class="text-lg font-bold mb-4 text-zinc-900 tracking-tight">AI Assistant</h3>
            <p id="api-desc" class="text-xs text-zinc-500 mb-4"></p>
            <input type="password" id="api-key-input" class="w-full border rounded px-3 py-2 text-sm mb-4 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Paste Gemini API Key">
            <input type="hidden" id="ai-mode">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('api-modal').classList.add('hidden')" class="px-4 py-2 text-xs font-bold text-zinc-500">Cancel</button>
                <button onclick="runAiProcess()" class="px-4 py-2 text-xs font-bold bg-indigo-600 text-white rounded">Execute</button>
            </div>
        </div>
    </div>

    <div id="table-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl w-80 font-sans">
            <h3 class="text-lg font-bold mb-4 text-zinc-900">Insert Table</h3>
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">Rows</label>
                    <input type="number" id="tbl-rows" value="2" min="1" max="20" class="w-full border rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-zinc-500 mb-1">Cols</label>
                    <input type="number" id="tbl-cols" value="2" min="1" max="10" class="w-full border rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('table-modal').classList.add('hidden')" class="px-4 py-2 text-xs font-bold text-zinc-500">Cancel</button>
                <button onclick="confirmInsertTable()" class="px-4 py-2 text-xs font-bold bg-indigo-600 text-white rounded">Insert</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const editor = document.getElementById('editor');
        const handle = document.getElementById('img-resizer-handle');
        const historyStack = []; let historyIndex = -1;
        let lastRange = null; let currentImg = null;
        const DEFAULT_GEMINI_KEY = "";

        // History
        function saveHistory() {
            const content = editor.innerHTML;
            if (historyIndex >= 0 && historyStack[historyIndex] === content) return;
            if (historyIndex < historyStack.length - 1) historyStack.splice(historyIndex + 1);
            historyStack.push(content); if (historyStack.length > 50) historyStack.shift(); else historyIndex++;
        }
        function undo() { if (historyIndex > 0) { historyIndex--; editor.innerHTML = historyStack[historyIndex]; initInteractive(); } }
        function redo() { if (historyIndex < historyStack.length - 1) { historyIndex++; editor.innerHTML = historyStack[historyIndex]; initInteractive(); } }

        function saveSelection() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                if (editor.contains(range.commonAncestorContainer)) lastRange = range.cloneRange();
            }
        }
        editor.addEventListener('mouseup', saveSelection);
        editor.addEventListener('keyup', saveSelection);

        // Paste Logic
        editor.addEventListener('paste', (e) => {
            const items = (e.clipboardData || window.clipboardData).items;
            let hasImage = false;
            for (let item of items) {
                if (item.kind === 'file' && item.type.includes('image/')) {
                    e.preventDefault(); hasImage = true;
                    const blob = item.getAsFile(); const reader = new FileReader();
                    reader.onload = (ev) => { const img = document.createElement('img'); img.src = ev.target.result; img.style.width = "100%"; insertNodeAtCursor(img); };
                    reader.readAsDataURL(blob);
                }
            }
            if (!hasImage) { 
                e.preventDefault(); 
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                const lines = text.split(/\r\n|\n|\r/);
                let htmlToInsert = '';
                lines.forEach(line => { if (line.trim() !== '') htmlToInsert += `<p class="text-base text-black mb-2 pl-12">${line}</p>`; });
                document.execCommand('insertHTML', false, htmlToInsert);
            }
            saveHistory();
        });

        function insertNodeAtCursor(node) {
            editor.focus(); const sel = window.getSelection();
            if (lastRange) { sel.removeAllRanges(); sel.addRange(lastRange); }
            if (sel.rangeCount > 0) { const range = sel.getRangeAt(0); range.deleteContents(); range.insertNode(node); const br = document.createElement('p'); br.innerHTML = '<br>'; node.after(br); } 
            else { editor.appendChild(node); }
            saveHistory(); deselectImage();
        }

        // --- TABLE CUSTOMIZATION ---
        function openTableModal() {
            // Restore selection to ensure we know where to insert
            if(lastRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(lastRange);
            }
            document.getElementById('table-modal').classList.remove('hidden');
        }

        function confirmInsertTable() {
            const rows = parseInt(document.getElementById('tbl-rows').value) || 2;
            const cols = parseInt(document.getElementById('tbl-cols').value) || 2;
            
            let headerCells = "";
            for(let i=0; i<cols; i++) headerCells += `<th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5;">H</th>`;
            
            let bodyRows = "";
            for(let r=0; r<rows-1; r++) { // -1 because 1st row is header
                let rowCells = "";
                for(let c=0; c<cols; c++) rowCells += `<td style="border:1px solid #d4d4d8; padding:8px;">&nbsp;</td>`;
                bodyRows += `<tr>${rowCells}</tr>`;
            }
            // If rows=1, only header. If rows>1, add body.
            // But let's assume 'rows' means Total Rows.
            if(rows < 1) return;

            // If user enters 1 row, we just give header? Or just data? Let's give Header row + (Rows-1) data rows.
            // If Rows = 2 -> 1 Header + 1 Data.
            
            let tableHtml = `<table style="width:calc(100% - 3rem); border-collapse: collapse; margin-left:3rem;"><tbody><tr>${headerCells}</tr>${bodyRows}</tbody></table><br>`;
            
            editor.focus();
            const sel = window.getSelection();
            if (lastRange) { sel.removeAllRanges(); sel.addRange(lastRange); }
            document.execCommand('insertHTML', false, tableHtml);
            
            document.getElementById('table-modal').classList.add('hidden');
            saveHistory();
        }

        // --- Page Break & Layout ---
        function insertPageBreak() {
            const breaks = editor.querySelectorAll('.page-break-marker');
            const nextPageNum = breaks.length + 1;
            const html = `<div class="page-break-marker" style="border-bottom: 2px dashed #cbd5e1; margin: 2rem 0; position: relative; text-align: center; page-break-after: always;" contenteditable="false"><span style="background:white; padding:0 10px; color:#94a3b8; font-size:12px; font-weight:600; text-transform: uppercase; letter-spacing: 1px;">--- Page ${nextPageNum} ---</span></div><p><br></p>`;
            editor.focus(); const sel = window.getSelection();
            if (lastRange) { sel.removeAllRanges(); sel.addRange(lastRange); }
            document.execCommand('insertHTML', false, html);
            saveHistory();
        }

        function deletePageBreak() {
            const breaks = editor.querySelectorAll('.page-break-marker');
            if(breaks.length > 0) {
                const last = breaks[breaks.length - 1];
                if(last.nextElementSibling && last.nextElementSibling.tagName === 'P' && last.nextElementSibling.innerText.trim() === '') last.nextElementSibling.remove();
                last.remove();
                saveHistory();
            } else { alert("No page breaks to delete."); }
        }

        function changePageWidth(cls) {
            const container = document.getElementById('paper-container');
            container.className = `${cls} mx-auto bg-white shadow-lg border border-zinc-200 min-h-full flex flex-col relative transition-all duration-300`;
            initInteractive();
        }

        // Standard
        function openAiModal(mode) {
            const modal = document.getElementById('api-modal');
            document.getElementById('ai-mode').value = mode;
            document.getElementById('api-title').innerText = mode === 'translate' ? "AI Engineering Translate" : "AI Engineering Refine";
            document.getElementById('api-desc').innerText = mode === 'translate' ? "EN → KO (Technical)" : "KO → KO (Formal)";
            document.getElementById('api-key-input').value = DEFAULT_GEMINI_KEY;
            modal.classList.remove('hidden');
        }

async function runAiProcess() {
    const key = document.getElementById('api-key-input').value.trim();
    const mode = document.getElementById('ai-mode').value;
    
    if(!key) {
        return alert("API Key를 입력해주세요.\n\nGoogle AI Studio에서 무료로 발급받을 수 있습니다:\nhttps://aistudio.google.com/app/apikey");
    }
    
    const loader = document.getElementById('trans-loader');
    loader.classList.remove('hidden');
    document.getElementById('api-modal').classList.add('hidden');
    
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    const textToProcess = selectedText || editor.innerText;
    
    if(!textToProcess) {
        loader.classList.add('hidden');
        return alert("번역할 텍스트를 선택하거나 입력해주세요.");
    }
    
    if(textToProcess.length > 10000) {
        loader.classList.add('hidden');
        return alert("텍스트가 너무 깁니다. (최대 10,000자)\n일부만 선택해서 번역해주세요.");
    }
    
    let prompt;
    if(mode === 'translate') {
        prompt = `You are a technical engineering translator. Translate the following English text to Korean using formal engineering terminology.

Rules:
- Use professional engineering vocabulary
- Maintain technical accuracy
- Keep the tone formal and precise
- Do NOT include any HTML tags or markdown in output
- Output ONLY the translated Korean text

Text to translate:
${textToProcess}`;
    } else {
        prompt = `다음 한글 텍스트를 공식적인 엔지니어링 용어로 다듬어주세요. 비속어나 구어체를 제거하고 기술 문서에 적합한 표현으로 변경하세요.

규칙:
- HTML 태그나 마크다운 없이 순수 텍스트만 출력
- 전문적이고 격식있는 표현 사용

텍스트:
${textToProcess}`;
    }
    
    // ✅ gemini-2.0-flash-exp 대신 안정적인 모델 사용
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`;
    
    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }]
            })
        });
        
        // ✅ 429 에러 처리 개선
        if(response.status === 429) {
            loader.classList.add('hidden');
            return alert("API 사용 한도를 초과했습니다.\n\n해결 방법:\n1. 몇 분 후 다시 시도하거나\n2. Google AI Studio에서 새 API 키를 발급받아주세요.\n\nhttps://aistudio.google.com/app/apikey");
        }
        
        if(!response.ok) {
            throw new Error(`API 오류: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log("API Response:", data);
        
        if(!data.candidates || data.candidates.length === 0) {
            if(data.promptFeedback?.blockReason) {
                throw new Error(`번역 차단됨: ${data.promptFeedback.blockReason}\n(콘텐츠 정책 위반 가능성)`);
            }
            throw new Error("번역 결과를 받지 못했습니다");
        }
        
        const candidate = data.candidates[0];
        
        if(candidate.finishReason && candidate.finishReason !== "STOP") {
            const reasons = {
                "SAFETY": "안전 필터에 의해 차단되었습니다",
                "MAX_TOKENS": "텍스트가 너무 깁니다. 더 짧게 선택해주세요",
                "RECITATION": "저작권 보호 콘텐츠가 감지되었습니다",
                "OTHER": "알 수 없는 이유로 중단되었습니다"
            };
            throw new Error(`번역 실패: ${reasons[candidate.finishReason] || candidate.finishReason}`);
        }
        
        if(!candidate.content || !candidate.content.parts || !candidate.content.parts[0]) {
            throw new Error("번역 결과를 받지 못했습니다 (content 필드 없음)");
        }
        
        const translatedText = candidate.content.parts[0].text
            .replace(/```html|```|```/g, '')
            .trim();
        
        if(!translatedText) {
            throw new Error("번역 결과가 비어있습니다");
        }
        
        // 결과 적용
        if(selectedText) {
            document.execCommand('insertText', false, translatedText);
        } else {
            editor.innerText = translatedText;
        }
        
        saveHistory();
        initInteractive();
        
        alert("✅ 번역이 완료되었습니다!");
        
    } catch(e) {
        console.error("Error details:", e);
        alert("❌ AI 처리 중 오류가 발생했습니다:\n\n" + e.message);
    } finally {
        loader.classList.add('hidden');
    }
}

        function insertStatusIcon(type) {
            let svg = "";
            if (type === 'warning') svg = `<span style="color:#ef4444; font-weight:bold; font-size:14px; display:inline-flex; align-items:center; gap:4px; vertical-align:middle; margin-right:4px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg> 경고:</span>`;
            else if (type === 'caution') svg = `<span style="color:#f59e0b; font-weight:bold; font-size:14px; display:inline-flex; align-items:center; gap:4px; vertical-align:middle; margin-right:4px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg> 주의:</span>`;
            else if (type === 'crucial') svg = `<span style="color:#3b82f6; font-weight:bold; font-size:14px; display:inline-flex; align-items:center; gap:4px; vertical-align:middle; margin-right:4px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg> 급소:</span>`;
            editor.focus(); const sel = window.getSelection(); if (lastRange) { sel.removeAllRanges(); sel.addRange(lastRange); }
            const span = document.createElement('span'); span.innerHTML = svg + "&nbsp;";
            if (sel.rangeCount > 0) { const range = sel.getRangeAt(0); range.deleteContents(); range.insertNode(span); range.collapse(false); } else { editor.appendChild(span); }
            saveHistory();
        }

        function insertImageFromFile(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img'); img.src = e.target.result; img.style.width = "100%"; insertNodeAtCursor(img);
            };
            reader.readAsDataURL(input.files[0]); input.value = '';
        }

        editor.addEventListener('click', (e) => { if (e.target.tagName === 'IMG') { e.stopPropagation(); selectImage(e.target); } else { deselectImage(); } });
        function selectImage(img) {
            deselectImage(); currentImg = img; img.classList.add('selected'); handle.style.display = 'block'; updateHandlePosition();
            handle.onmousedown = (e) => {
                e.preventDefault(); const startX = e.clientX, startW = img.offsetWidth, ratio = img.offsetHeight / img.offsetWidth;
                document.onmousemove = (me) => { img.style.width = (startW + (me.clientX - startX)) + 'px'; img.style.height = (img.offsetWidth * ratio) + 'px'; updateHandlePosition(); };
                document.onmouseup = () => { document.onmousemove = null; saveHistory(); };
            };
        }
        function updateHandlePosition() { if (!currentImg) return; const r = currentImg.getBoundingClientRect(); handle.style.top = (r.top + r.height - 7) + 'px'; handle.style.left = (r.left + r.width - 7) + 'px'; }
        function deselectImage() { handle.style.display = 'none'; editor.querySelectorAll('img').forEach(i => i.classList.remove('selected')); currentImg = null; }
        document.getElementById('canvas-wrapper').addEventListener('scroll', updateHandlePosition);
        document.addEventListener('keydown', (e) => { if ((e.key === 'Delete' || e.key === 'Backspace') && currentImg) { e.preventDefault(); currentImg.remove(); deselectImage(); saveHistory(); } });

        function modifyTable(target, action) {
            const sel = window.getSelection(); if (!sel.rangeCount) return;
            let cell = sel.anchorNode; while(cell && cell.nodeName !== 'TD' && cell.nodeName !== 'TH') { cell = cell.parentNode; if(cell === editor) return; }
            if(!cell) return alert("Click table cell.");
            const row = cell.parentNode, table = row.parentNode.parentNode;
            if (target === 'merge') {
                if (action === 'right' && cell.nextElementSibling) { cell.colSpan = (cell.colSpan||1) + (cell.nextElementSibling.colSpan||1); cell.nextElementSibling.remove(); }
                else if (action === 'down' && table.rows[row.rowIndex + 1]) { const b = table.rows[row.rowIndex + 1].cells[cell.cellIndex]; if(b) { cell.rowSpan = (cell.rowSpan||1) + (b.rowSpan||1); b.remove(); } }
            } else if (target === 'split') { cell.colSpan = 1; cell.rowSpan = 1; }
            else if (target === 'row') {
                if (action === 'add') { const nr = table.insertRow(row.rowIndex + 1); for(let i=0; i<row.cells.length; i++) { const c = nr.insertCell(i); c.style.border="1px solid #d4d4d8"; c.style.padding="8px"; c.innerHTML="&nbsp;"; } }
                else if (action === 'del' && table.rows.length>1) table.deleteRow(row.rowIndex);
            } else if (target === 'col') {
                const idx = cell.cellIndex;
                if (action === 'add') { for(let i=0; i<table.rows.length; i++) { const c = table.rows[i].insertCell(idx+1); c.style.border="1px solid #d4d4d8"; c.style.padding="8px"; c.innerHTML="&nbsp;"; if(table.rows[i].cells[idx].tagName==='TH') c.outerHTML='<th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5;">H</th>'; } }
                else if (action === 'del') { for(let i=0; i<table.rows.length; i++) { if(table.rows[i].cells.length>1) table.rows[i].deleteCell(idx); } }
            }
            saveHistory(); attachResizers();
        }

        function attachResizers() {
            editor.querySelectorAll('table').forEach(table => {
                if (!table.rows[0]) return;
                Array.from(table.rows[0].cells).forEach(cell => {
                    if (cell.querySelector('.resizer')) return;
                    const r = document.createElement('div'); r.className = 'resizer'; r.contentEditable = false; cell.appendChild(r);
                    r.onmousedown = (e) => { 
                        let x = e.clientX, w = parseInt(getComputedStyle(cell).width, 10);
                        document.onmousemove = (me) => cell.style.width = (w + me.clientX - x) + 'px';
                        document.onmouseup = () => { document.onmousemove = null; saveHistory(); };
                        e.preventDefault();
                    };
                });
            });
        }

        function initInteractive() { attachResizers(); deselectImage(); lucide.createIcons(); }
        window.onload = function() {
            updateMeta(); document.execCommand('defaultParagraphSeparator', false, 'p'); saveHistory();
            new MutationObserver(() => initInteractive()).observe(editor, { childList: true, subtree: true });
        };

        function execCmd(c, v=null) {
            if (currentImg && ['justifyLeft', 'justifyCenter', 'justifyRight'].includes(c)) {
                currentImg.style.marginLeft = (c === 'justifyLeft') ? "0" : "auto";
                currentImg.style.marginRight = (c === 'justifyRight') ? "0" : "auto";
                updateHandlePosition();
            } else { document.execCommand(c, false, v); }
            editor.focus(); saveHistory();
        }

        function applyStyle(t) {
            document.execCommand('formatBlock', false, 'p'); const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                let n = sel.anchorNode; while (n && n.nodeName !== 'P' && n !== editor) n = n.parentNode;
                if (n && n.nodeName === 'P') {
                    n.className = t==='H1' ? 'text-xl font-bold text-black mb-4 mt-6 pl-0' : t==='H2' ? 'text-lg font-bold text-black mb-3 mt-4 pl-6' : 'text-base text-black mb-2 pl-12';
                    if(t==='TB') n.classList.add('font-bold');
                }
            }
            saveHistory();
        }

        function changeDocType(type) {
            const name = document.getElementById('meta-name').value || "Process Name";
            if (type === 'CONTENTS') {
                editor.innerHTML = `<h1 class="text-xl font-bold text-black mb-4 mt-6 pl-0">1. ${name}</h1><p class="text-base text-black mb-2 pl-12">Start typing here...</p>`;
            } else if (type === 'HISTORY') {
                editor.innerHTML = `
                    <h1 class="text-xl font-bold text-black mb-4 mt-6 pl-0">Revision History</h1>
                    <div style="padding-left:3rem; margin-bottom:2rem; font-size:14px; color:#333; line-height:1.8;">
                        <p><strong>1. Document Number :</strong> </p>
                        <p><strong>2. Standard Applicable Model :</strong> APG-2012HD</p>
                        <p><strong>3. General Applicable Model :</strong> APG-2012H, APG-2012HE</p>
                        <p><strong>4. OMS Type :</strong> Assembly</p>
                    </div>
                    <table style="width:calc(100% - 3rem); border-collapse: collapse; margin-left:3rem;">
                        <thead>
                            <tr>
                                <th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:60px;">Rev.</th>
                                <th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:100px;">Date</th>
                                <th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:80px;">Change #</th>
                                <th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5;">Description of Change</th>
                                <th style="border:1px solid #d4d4d8; padding:8px; background:#f4f4f5; width:80px;">ORG</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border:1px solid #d4d4d8; padding:8px;">001</td>
                                <td style="border:1px solid #d4d4d8; padding:8px;">${new Date().toISOString().split('T')[0]}</td>
                                <td style="border:1px solid #d4d4d8; padding:8px;">&nbsp;</td>
                                <td style="border:1px solid #d4d4d8; padding:8px;">Initial Release</td>
                                <td style="border:1px solid #d4d4d8; padding:8px;">&nbsp;</td>
                            </tr>
                        </tbody>
                    </table><br>
                `;
            }
            saveHistory(); initInteractive();
        }

        function handleFileLoad(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const doc = new DOMParser().parseFromString(e.target.result, "text/html");
                try {
                    const meta = doc.querySelector('.meta').innerText.split(' / ');
                    document.getElementById('meta-type').value = meta[0].trim();
                    document.getElementById('meta-model').value = meta[1].trim();
                    document.getElementById('meta-process').value = meta[2].trim();
                    document.getElementById('meta-step').value = doc.querySelector('.badge-black').innerText.trim();
                    document.getElementById('meta-name').value = doc.querySelector('h1').innerText.trim();
                } catch(err) {}
                editor.innerHTML = doc.querySelector('main').innerHTML;
                saveHistory(); updateMeta(); initInteractive();
            };
            reader.readAsText(input.files[0]); input.value = '';
        }
        function saveHtml() {
            deselectImage(); const meta = updateMeta();
            const temp = document.createElement('div'); temp.innerHTML = editor.innerHTML;
            temp.querySelectorAll('.resizer, .img-handle').forEach(el => el.remove());
            const content = temp.innerHTML.replace(/text-zinc-[0-9]+/g, 'text-black');
            const layoutClass = document.getElementById('page-layout').value;
            const widthStyle = layoutClass === 'paper-wide' ? 'width: 330mm;' : 'width: 210mm;';
            const finalHtml = `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${meta.full}</title><script src="https://cdn.tailwindcss.com"><\/script><script src="https://unpkg.com/lucide@latest"><\/script><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet"><style>body { font-family: 'Inter', 'Noto Sans KR', sans-serif; background-color: #f4f4f5; margin: 0; padding: 40px 0; display: flex; justify-content: center; } .paper { ${widthStyle} min-height: 297mm; background: white; padding: 40px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); position: relative; display: flex; flex-direction: column; } header { border-bottom: 4px double #000; padding-bottom: 20px; margin-bottom: 30px; } .badge-black { background: #000; color: #fff; padding: 4px 14px; border-radius: 9999px; font-size: 22px; font-weight: 700; } .meta { display: flex; align-items: center; gap: 24px; text-[10px] font-bold text-zinc-500 uppercase tracking-widest; padding-left: 3rem; margin-bottom: 12px; } main { flex: 1; line-height: 1.6; color: #000; padding-left: 3rem; } footer { border-top: 1px solid #e2e8f0; margin-top: 50px; padding-top: 20px; text-align: center; opacity: 0.5; } img { border-radius: 4px; }</style></head><body><div class="paper"><header><div class="meta">${meta.type} / ${meta.model} / ${meta.proc}</div><div class="flex items-end gap-4" style="padding-left:3rem;"><span class="badge-black">${meta.step}</span><h1 style="font-size:28px; font-weight:800; margin:0;">${meta.name}</h1></div></header><main>${content}</main><footer><img src="https://asendia2025.github.io/mfg-capa/img/logo_company.png" style="height:18px; margin:0 auto 6px;"><div style="font-size:9px; font-weight:700; color:#94a3b8; text-transform:uppercase;">Manufacturing Technology Center</div></footer></div><script>lucide.createIcons();<\/script></body></html>`;
            saveAs(new Blob([finalHtml], {type: "text/html;charset=utf-8"}), `${meta.full}.html`);
        }
        function formatStep(i) { i.value = i.value.replace(/[^0-9]/g, '').padStart(3, '0') || '001'; }
        function updateMeta() {
            const s = document.getElementById('meta-step').value || "001", n = document.getElementById('meta-name').value || "NAME";
            const full = `${s}-${n.replace(/[^a-zA-Z0-9\s-_]/g, '').trim()}`;
            document.getElementById('full-name-display').innerText = full + ".html";
            return { full, step: s, name: n, type: document.getElementById('meta-type').value, model: document.getElementById('meta-model').value, proc: document.getElementById('meta-process').value };
        }
        function checkStepAuto(i) { if(i.value === '000') document.getElementById('meta-name').value = "DOC. Revision History"; updateMeta(); }
        function confirmTranslation() { document.getElementById('api-key-input').value = DEFAULT_GEMINI_KEY; document.getElementById('api-modal').classList.remove('hidden'); }
    </script>
</body>
</html>
